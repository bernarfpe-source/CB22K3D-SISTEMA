<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CB¬≤K PRESENTES 3D ‚Ä¢ SISTEMA INTEGRAL V21.0</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <style>
    :root {
      --bg: #F0F4F8; --surface-0: #FFFFFF; --surface-1: #E1E8F0; --surface-2: #D1DBE8;
      --text: #1A2B3C; --text-dim: #5A7184; --accent: #2D5BFF; --accent-soft: rgba(45, 91, 255, 0.1);
      --accent-2: #00A3FF; --warn: #F59E0B; --danger: #EF4444; --border: rgba(26, 43, 60, 0.08); --radius: 16px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; text-transform: uppercase; }
    html, body { height: 100%; overflow: hidden; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); }
    
    /* MODAL SISTEMA */
    #modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    .modal-content { background: var(--surface-0); width: 600px; max-height: 85vh; border-radius: 24px; padding: 32px; overflow-y: auto; position: relative; }
    .close-modal { position: absolute; top: 20px; right: 20px; cursor: pointer; font-size: 20px; font-weight: 800; color: var(--danger); }

    /* LOGIN SCREEN */
    #login-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    .login-card { background: var(--surface-0); padding: 48px; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.05); width: 400px; text-align: center; border: 1px solid var(--border); }
    .brand-mark { font-size: 36px; font-weight: 800; color: var(--accent); letter-spacing: -1px; }

    body { display: grid; grid-template-columns: 280px 1fr; }
    aside { background: var(--surface-0); border-right: 1px solid var(--border); padding: 32px 20px; display: flex; flex-direction: column; height: 100vh; }
    .sidebar-brand { text-align: center; margin-bottom: 30px; }
    .nav-btn { background: none; border: none; color: var(--text-dim); padding: 14px 16px; text-align: left; cursor: pointer; border-radius: 12px; font-size: 13px; font-weight: 700; margin-bottom: 8px; transition: 0.3s; display: flex; align-items: center; gap: 12px; }
    .nav-btn.active { background: var(--accent); color: #FFFFFF; box-shadow: 0 8px 16px rgba(45, 91, 255, 0.2); }
    
    main { padding: 40px; overflow-y: auto; height: 100vh; width: 100%; }
    .card { background: var(--surface-0); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; margin-bottom: 24px; }
    label { display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 6px; font-weight: 800; }
    input, select { width: 100%; padding: 14px; background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 12px; outline: none; font-size: 12px; font-weight: 600; }
    
    /* DASHBOARD BI */
    .bi-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 32px; }
    .bi-card { background: var(--accent); color: #FFF; padding: 25px; border-radius: 24px; text-align: center; }
    .bi-card.alt { background: var(--surface-0); color: var(--text); border: 1px solid var(--border); }
    
    .btn-primary { background: var(--accent); color: #FFFFFF; padding: 16px; border: none; border-radius: 14px; font-weight: 800; cursor: pointer; width: 100%; transition: 0.2s; }
    .btn-sm { padding: 10px 14px; font-size: 10px; border-radius: 8px; cursor: pointer; font-weight: 800; border: none; color: #fff; }
    
    .kanban-board { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
    .kanban-col { background: var(--surface-1); border-radius: 20px; padding: 15px; min-height: 600px; border: 1px solid var(--border); }
    .order-card { background: var(--surface-0); border-radius: 14px; padding: 15px; margin-bottom: 12px; border-left: 5px solid var(--accent-2); cursor: pointer; }
    
    .vitrine-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
    .vitrine-item { background: var(--surface-0); border-radius: 20px; border: 1px solid var(--border); overflow: hidden; }
    .moldura { height: 160px; background: var(--surface-1); display: flex; align-items: center; justify-content: center; }
    .vitrine-img { max-width: 90%; max-height: 90%; object-fit: contain; }
    
    .hide { display: none !important; }
    .tag-material { background: var(--surface-2); padding: 5px 10px; border-radius: 8px; font-size: 9px; font-weight: 700; display: inline-block; margin: 3px; color: var(--text); }
    table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
    td, th { padding: 12px; text-align: left; font-size: 11px; background: var(--bg); }
  </style>
</head>
<body>

  <div id="modal-overlay"><div class="modal-content"><span class="close-modal" onclick="closeModal()">X</span><h2 id="m-id-title" style="color:var(--accent); font-weight:800; margin-bottom:10px;">DETALHES</h2><div id="m-detalhes-corpo"></div></div></div>

  <div id="login-overlay">
    <div class="login-card">
      <div class="brand-mark">CB¬≤K</div>
      <div style="font-size: 11px; font-weight: 700; color: var(--text-dim); margin-bottom: 30px; letter-spacing: 2px;">PRESENTES 3D</div>
      <div style="text-align: left; margin-bottom: 15px;"><label>USU√ÅRIO</label><input type="text" id="login-user"></div>
      <div style="text-align: left; margin-bottom: 25px;"><label>SENHA</label><input type="password" id="login-pass"></div>
      <button class="btn-primary" onclick="checkLogin()">ACESSAR</button>
    </div>
  </div>

  <aside>
    <div class="sidebar-brand">
        <div style="font-size: 24px; font-weight: 800; color: var(--accent);">CB¬≤K</div>
        <div style="font-size: 9px; font-weight: 700; color: var(--text-dim); letter-spacing: 1px;">PRESENTES 3D</div>
    </div>
    <nav id="mainNav">
      <button class="nav-btn active" data-view="dashboard">üìä DASHBOARD</button>
      <button class="nav-btn" data-view="vitrine">üì¶ VITRINE</button>
      <button class="nav-btn" data-view="orcamento">üßæ OR√áAMENTO</button>
      <button class="nav-btn" data-view="estoque">üßµ ESTOQUE</button>
      <button class="nav-btn admin-only" data-view="maquinas">‚öôÔ∏è M√ÅQUINAS</button>
      <button class="nav-btn admin-only" data-view="usuarios" style="margin-top: 20px; color: var(--accent-2);">üë• USU√ÅRIOS</button>
    </nav>
    <div style="margin-top: auto; padding: 20px; background: var(--surface-1); border-radius: 16px;">
      <div id="current-op-role" style="font-size: 10px; font-weight: 800;">---</div>
      <strong id="current-op-name" style="font-size:12px;">---</strong>
      <button class="btn-sm" style="background: var(--surface-2); width: 100%; margin-top: 15px; color: var(--text);" onclick="logout()">SAIR</button>
    </div>
  </aside>

  <main>
    <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
      <h1 id="viewTitle">DASHBOARD</h1>
      <button class="btn-primary" onclick="exportData()" style="width: auto; padding: 12px 24px; background: var(--surface-1); color: var(--text);">üì¶ BACKUP</button>
    </header>

    <section id="view-dashboard">
      <div class="bi-row" id="bi-container">
        <div class="bi-card"><div>FATURAMENTO REAL</div><strong id="bi-faturamento" style="font-size: 26px;">R$ 0,00</strong></div>
        <div class="bi-card alt"><div>PEDIDOS</div><strong id="bi-qtd" style="font-size: 26px;">0</strong></div>
        <div class="bi-card alt"><div>TICKET M√âDIO</div><strong id="bi-ticket" style="font-size: 26px;">R$ 0,00</strong></div>
      </div>
      <div class="kanban-board">
        <div class="kanban-col"><div class="kanban-title">üì• A FAZER <span id="cnt-af">0</span></div><div id="list-afazer"></div></div>
        <div class="kanban-col"><div class="kanban-title">‚úÖ APROVADOS <span id="cnt-ap">0</span></div><div id="list-aprovado"></div></div>
        <div class="kanban-col"><div class="kanban-title">‚öôÔ∏è PRODU√á√ÉO <span id="cnt-pr">0</span></div><div id="list-produzindo"></div></div>
        <div class="kanban-col"><div class="kanban-title">üèÅ FINALIZADOS <span id="cnt-fi">0</span></div><div id="list-finalizado"></div></div>
      </div>
    </section>

    <section id="view-estoque" class="hide">
        <div class="card"><div class="grid" style="display:grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap:12px; align-items: end;"><div><label>NOME MATERIAL</label><input id="s_material_nome"></div><div><label>PESO (G)</label><input id="s_peso" type="number"></div><div><label>CUSTO</label><input id="s_custo" type="number"></div><button class="btn-primary" onclick="addEstoque()">SALVAR</button></div></div>
        <div class="card"><table><thead><tr><th>MATERIAL</th><th>SALDO ATUAL</th><th style="text-align:right">A√á√ÉO</th></tr></thead><tbody id="tbl-estoque-corpo"></tbody></table></div>
    </section>

    <section id="view-orcamento" class="hide">
        <div class="card"><div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;"><div><label>CLIENTE</label><input id="c-nome"></div><div><label>WA</label><input id="c-tel"></div></div></div>
        <div class="card"><table><thead><tr><th>PE√áA</th><th>MATERIAIS</th><th>CUSTO BASE</th><th style="text-align:right">A√á√ÉO</th></tr></thead><tbody id="tbl-carrinho"></tbody></table></div>
        <div class="card">
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;">
              <div><label>IMP %</label><input id="o-imp" type="number" value="6" oninput="atualizarResumoFinal()"></div>
              <div><label>MKT %</label><input id="o-mkt" type="number" value="0" oninput="atualizarResumoFinal()"></div>
              <div><label>EMBALAGEM</label><input id="o-embalagem" type="number" value="5" oninput="atualizarResumoFinal()"></div>
              <div><label>FRETE</label><input id="o-frete" type="number" value="0" oninput="atualizarResumoFinal()"></div>
              <div><label>MARGEM %</label><input id="o-margem" type="number" value="100" oninput="atualizarResumoFinal()"></div>
            </div>
            <div style="margin-top: 20px; background: var(--accent-soft); padding: 25px; border-radius: 12px; text-align: center; border: 1px solid var(--accent);">
                <strong id="val-final-total" style="font-size: 32px; color: var(--accent);">R$ 0,00</strong>
            </div>
            <button class="btn-primary" style="margin-top: 20px; background: #25D366;" onclick="finalizarPedidoV21()">FECHAR NO KANBAN E LIMPAR</button>
        </div>
    </section>

    <section id="view-vitrine" class="hide">
        <div class="card">
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 32px;">
                <div><label>FOTO</label><input type="file" id="v-file" onchange="processImage(event)"><div id="img-preview" style="height: 150px; border: 2px dashed var(--border); margin-top: 10px; display: grid; place-items: center; border-radius: 12px;">PREVIEW</div></div>
                <div><label>NOME</label><input id="v-nome"><div style="background: var(--bg); padding: 15px; border-radius: 12px; margin-top: 15px;"><div style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 10px;"><select id="v-add-est-id"></select><input id="v-add-gramas" type="number" placeholder="G"><button class="btn-sm" style="background: var(--accent);" onclick="v_addMaterial()">ADD</button></div><div id="v-lista-materiais" style="margin-top: 10px;"></div></div><button class="btn-primary" style="margin-top: 20px;" onclick="addVitrine()">SALVAR NA VITRINE</button></div>
            </div>
        </div>
        <div class="vitrine-grid" id="grid-vitrine"></div>
    </section>

    <section id="view-maquinas" class="hide">
        <div class="card"><table><thead><tr><th>NOME</th><th>WATTS</th><th>TAXA/H</th><th style="text-align:right">A√á√ÉO</th></tr></thead><tbody id="tbl-maquinas-corpo"></tbody></table></div>
    </section>

    <section id="view-usuarios" class="hide">
        <div class="card"><div class="grid" style="display:grid; grid-template-columns: 2fr 1fr 1fr auto; gap:12px; align-items: end;"><div><label>NOME</label><input id="u-name"></div><div><label>SENHA</label><input id="u-pass" type="password"></div><div><label>N√çVEL</label><select id="u-role"><option value="OPERADOR">OPERADOR</option><option value="ADMIN">ADMINISTRADOR</option></select></div><button class="btn-primary" onclick="addUser()">ADD</button></div></div>
        <div class="card"><table><thead><tr><th>NOME</th><th>N√çVEL</th><th style="text-align:right">A√á√ÉO</th></tr></thead><tbody id="tbl-usuarios"></tbody></table></div>
    </section>

  </main>

  <script>
    const STORAGE_KEY = 'CB2K_ERP_V21_FINAL';
    const SETUP = { 
      pedidos: [], 
      estoque: [
        {id: 101, nome: 'PLA BRANCO 1000G', peso_inicial: 1000, peso_atual: 1000, custo: 90.00},
        {id: 102, nome: 'PLA BRANCO 500G', peso_inicial: 500, peso_atual: 500, custo: 50.00},
        {id: 104, nome: 'PLA PRETO 1000G', peso_inicial: 1000, peso_atual: 1000, custo: 90.00}
      ], 
      vitrine: [], 
      maquinas: [
        {id: 1, nome: 'BAMBU LAB P1S', watts: 150, deprec: 5.0},
        {id: 2, nome: 'BAMBU LAB A1', watts: 120, deprec: 4.0},
        {id: 3, nome: 'BAMBU LAB A1 MINI', watts: 100, deprec: 3.0}
      ],
      usuarios: [{name: 'ADMIN', pass: '1234', role: 'ADMIN'}], config: {kwh: 1.20}
    };
    let DB = JSON.parse(localStorage.getItem(STORAGE_KEY)) || SETUP;
    let curUser = null, tempMateriais = [], compressedImg = "", carrinho = [];

    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(DB)); renderAll(); }

    function checkLogin() {
      const u = document.getElementById('login-user').value.trim().toUpperCase(), p = document.getElementById('login-pass').value.trim();
      const user = DB.usuarios.find(x => x.name === u && x.pass === p);
      if(user) { 
        curUser = user; document.getElementById('login-overlay').style.display = 'none'; document.getElementById('current-op-name').innerText = u; document.getElementById('current-op-role').innerText = user.role;
        if(user.role === 'ADMIN') document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hide'));
        renderAll();
      } else { alert("ACESSO NEGADO"); }
    }
    function logout() { location.reload(); }

    function navegarPara(v) { 
        document.querySelectorAll('section').forEach(s => s.classList.add('hide')); 
        document.getElementById('view-' + v).classList.remove('hide'); 
        document.querySelectorAll('.nav-btn').forEach(b => { b.classList.remove('active'); if(b.dataset.view === v) b.classList.add('active'); }); 
        document.getElementById('viewTitle').innerText = v.toUpperCase();
        renderAll(); 
    }

    function atualizarResumoFinal() {
        const custoBase = carrinho.reduce((s, i) => s + i.custoFinalItem, 0);
        const imp = Number(document.getElementById('o-imp').value)/100, mkt = Number(document.getElementById('o-mkt').value)/100, emb = Number(document.getElementById('o-embalagem').value), fr = Number(document.getElementById('o-frete').value), margem = Number(document.getElementById('o-margem').value)/100;
        const valorVenda = (custoBase + emb + fr) * (1 + imp + mkt) * (1 + margem);
        document.getElementById('val-final-total').innerText = `R$ ${valorVenda.toFixed(2)}`;
        return valorVenda;
    }

    function finalizarPedidoV21() {
        const cN = document.getElementById('c-nome'), cT = document.getElementById('c-tel');
        if(!cN.value || carrinho.length === 0) return alert("ERRO: DADOS INCOMPLETOS");
        carrinho.forEach(peca => { peca.materiais.forEach(matUsado => { const itemEstoque = DB.estoque.find(e => e.id == matUsado.id); if(itemEstoque) itemEstoque.peso_atual -= parseFloat(matUsado.g); }); });
        const valorVendaFinal = atualizarResumoFinal();
        DB.pedidos.unshift({ id: Date.now(), cliente: cN.value.toUpperCase(), tel: cT.value, valor: valorVendaFinal, status: 'A FAZER', itens: JSON.parse(JSON.stringify(carrinho)), data: new Date().toLocaleDateString() });
        carrinho = []; cN.value = ""; cT.value = ""; save(); navegarPara('dashboard');
    }

    // FUN√á√ÉO PDF
    function gerarPDF(pId) {
        const p = DB.pedidos.find(x => x.id === pId);
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFont("helvetica", "bold"); doc.text("CB2K PRESENTES 3D - RECIBO", 20, 20);
        doc.setFont("helvetica", "normal"); doc.text(`CLIENTE: ${p.cliente}`, 20, 40); doc.text(`DATA: ${p.data}`, 20, 50);
        doc.text("ITENS:", 20, 70);
        p.itens.forEach((it, idx) => { doc.text(`- ${it.titulo}`, 25, 80 + (idx * 10)); });
        doc.setFont("helvetica", "bold"); doc.text(`TOTAL: R$ ${p.valor.toFixed(2)}`, 20, 150);
        doc.save(`RECIBO_${p.cliente}.pdf`);
    }

    function renderAll() {
        if(curUser?.role === 'ADMIN') {
            const tot = DB.pedidos.reduce((s, p) => s + (parseFloat(p.valor) || 0), 0);
            document.getElementById('bi-faturamento').innerText = `R$ ${tot.toFixed(2)}`;
            document.getElementById('bi-qtd').innerText = DB.pedidos.length;
            document.getElementById('bi-ticket').innerText = `R$ ${(tot / (DB.pedidos.length || 1)).toFixed(2)}`;
        }
        document.getElementById('tbl-usuarios').innerHTML = DB.usuarios.map(u => `<tr><td>${u.name}</td><td>${u.role}</td><td style="text-align:right">${u.name !== 'ADMIN' ? `<button class="btn-sm" style="background:var(--danger);" onclick="deleteItem('usuarios', '${u.name}')">X</button>` : '---'}</td></tr>`).join('');
        document.getElementById('grid-vitrine').innerHTML = DB.vitrine.map(v => `<div class="vitrine-item"><div class="moldura"><img src="${v.foto}" class="vitrine-img"></div><div style="padding:15px; text-align:center;"><div style="font-size:11px; font-weight:800; margin-bottom:10px;">${v.nome}</div><button class="btn-primary" style="padding:8px; font-size:9px;" onclick="enviarParaOrcamento(${v.id})">OR√áAR</button></div></div>`).join('');
        document.getElementById('tbl-estoque-corpo').innerHTML = DB.estoque.map(e => `<tr><td>${e.nome}</td><td>${parseFloat(e.peso_atual).toFixed(0)}G</td><td style="text-align:right"><button class="btn-sm" style="background:var(--danger);" onclick="deleteItem('estoque', ${e.id})">X</button></td></tr>`).join('');
        document.getElementById('tbl-maquinas-corpo').innerHTML = DB.maquinas.map(m => `<tr><td>${m.nome}</td><td>${m.watts}W</td><td style="text-align:right"><button class="btn-sm" style="background:var(--danger);" onclick="deleteItem('maquinas', ${m.id})">X</button></td></tr>`).join('');
        document.getElementById('v-add-est-id').innerHTML = DB.estoque.map(e => `<option value="${e.id}">${e.nome}</option>`).join('');
        renderKanban();
    }

    function deleteItem(cat, id) { if(confirm("EXCLUIR?")) { if(cat==='usuarios'){DB.usuarios=DB.usuarios.filter(u=>u.name!==id)}else{DB[cat]=DB[cat].filter(x=>x.id!==id)} save(); } }
    function addUser() { const nI = document.getElementById('u-name'), pI = document.getElementById('u-pass'); if(!nI.value) return; DB.usuarios.push({ name: nI.value.toUpperCase(), pass: pI.value, role: document.getElementById('u-role').value }); nI.value=""; save(); }
    function addVitrine() { const nI = document.getElementById('v-nome'); if(!nI.value || tempMateriais.length === 0) return alert("ERRO"); DB.vitrine.push({ id: Date.now(), nome: nI.value.toUpperCase(), materiais: [...tempMateriais], maqId: DB.maquinas[0].id, horas: 1, foto: compressedImg }); nI.value=""; tempMateriais=[]; save(); }
    function v_addMaterial() { const eId = document.getElementById('v-add-est-id').value, g = document.getElementById('v-add-gramas').value; const e = DB.estoque.find(x => x.id == eId); if(e && g) { tempMateriais.push({ id: e.id, nome: e.nome, g: parseFloat(g) }); document.getElementById('v-lista-materiais').innerHTML = tempMateriais.map(m => `<span class="tag-material">${m.nome}</span>`).join(''); } }
    function enviarParaOrcamento(id) { const v = DB.vitrine.find(x => x.id === id), m = DB.maquinas[0]; let cM = 0; v.materiais.forEach(mat => { const e = DB.estoque.find(x => x.id == mat.id); if(e) cM += mat.g * (e.custo / 1000); }); const cE = (m.watts / 1000) * 1 * DB.config.kwh, cD = 1 * m.deprec; carrinho.push({ id: Date.now(), titulo: v.nome, materiais: v.materiais, custoFinalItem: cM + cE + cD }); navegarPara('orcamento'); }
    function renderCarrinho() { document.getElementById('tbl-carrinho').innerHTML = carrinho.map((it, idx) => `<tr><td>${it.titulo}</td><td>${it.materiais.length} MATS</td><td>R$ ${it.custoFinalItem.toFixed(2)}</td><td style="text-align:right"><button class="btn-sm" style="background:var(--danger);" onclick="carrinho.splice(${idx},1);renderCarrinho();">X</button></td></tr>`).join(''); }
    
    function renderKanban() {
      const cols = { 'A FAZER': 'list-afazer', 'APROVADO': 'list-aprovado', 'EM PRODU√á√ÉO': 'list-produzindo', 'FINALIZADO': 'list-finalizado' };
      Object.values(cols).forEach(id => { const el = document.getElementById(id); if(el) el.innerHTML = ''; });
      DB.pedidos.forEach(p => {
        const html = `<div class="order-card" onclick="openModal(${p.id})"><div style="font-weight:800; color:var(--accent); font-size:10px;">#${p.id.toString().slice(-4)} - ${p.cliente}</div><div style="font-size:9px; margin:5px 0;">TOTAL: R$ ${parseFloat(p.valor).toFixed(2)}</div><div style="display:flex; gap:5px;" onclick="event.stopPropagation()">${p.status === 'FINALIZADO' ? `<button class="btn-sm" style="background:var(--warn);" onclick="gerarPDF(${p.id})">üìÑ PDF</button>` : `<button class="btn-sm" style="background:var(--accent);" onclick="updateStatus(${p.id})">AVAN√áAR</button>`} <button class="btn-sm" style="background:var(--danger);" onclick="deleteItem('pedidos', ${p.id})">X</button></div></div>`;
        const colEl = document.getElementById(cols[p.status]); if(colEl) colEl.innerHTML += html;
      });
    }
    function updateStatus(id) { const p = DB.pedidos.find(x => x.id === id); const ord = ['A FAZER', 'APROVADO', 'EM PRODU√á√ÉO', 'FINALIZADO']; p.status = ord[ord.indexOf(p.status) + 1]; save(); }
    function openModal(id) { const p = DB.pedidos.find(x => x.id === id); document.getElementById('m-detalhes-corpo').innerHTML = `<p><b>CLIENTE:</b> ${p.cliente}</p><p style="color:var(--accent);"><b>TOTAL: R$ ${p.valor.toFixed(2)}</b></p><hr style="margin:10px 0; border:0; border-top:1px solid var(--border);">${p.itens.map(i => `<p>‚ûî ${i.titulo}</p>`).join('')}`; document.getElementById('modal-overlay').style.display = 'flex'; }
    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
    function addEstoque() { const nI = document.getElementById('s_material_nome'), pI = document.getElementById('s_peso'), cI = document.getElementById('s_custo'); if(!nI.value) return; DB.estoque.push({ id: Date.now(), nome: nI.value.toUpperCase(), peso_inicial: pI.value, peso_atual: pI.value, custo: cI.value }); save(); }
    function processImage(e) { const r = new FileReader(); r.onload = (ev) => { const i = new Image(); i.onload = () => { const c = document.createElement('canvas'); c.width = 300; c.height = i.height * (300 / i.width); c.getContext('2d').drawImage(i, 0, 0, c.width, c.height); compressedImg = c.toDataURL('image/jpeg', 0.7); document.getElementById('img-preview').innerHTML = `<img src="${compressedImg}" style="height:100%; width:100%; object-fit:contain; border-radius:8px;">`; }; i.src = ev.target.result; }; r.readAsDataURL(e.target.files[0]); }
    document.getElementById('mainNav').addEventListener('click', (e) => { const b = e.target.closest('.nav-btn'); if (b) navegarPara(b.dataset.view); });
    function exportData() { const b = new Blob([JSON.stringify(DB)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `CB2K_MASTER_FINAL.json`; a.click(); }
    renderAll();
  </script>
</body>
</html>
